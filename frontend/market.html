<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishisalah - Market Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo a {
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
        }
        
        .logo i {
            margin-right: 10px;
            color: #4ecdc4;
            font-size: 28px;
        }
        
        .nav-menu {
            display: flex;
            list-style: none;
        }
        
        .nav-item {
            margin-left: 25px;
        }
        
        .nav-link {
            color: #ddd;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            padding: 10px 0;
            position: relative;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #4ecdc4;
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: #4ecdc4;
            transition: width 0.3s;
        }
        
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }
        
        .nav-auth {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .nav-login {
            color: #ddd;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-login:hover {
            color: #4ecdc4;
        }
        
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 3px 0;
            transition: 0.3s;
        }
        
        .market-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .market-header {
            margin-bottom: 30px;
        }
        
        .market-header h1 {
            font-size: 32px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .market-header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .market-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px 0 0 6px;
            font-size: 16px;
        }
        
        .search-box button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4ecdc4, #2c3e50);
            color: white;
            border: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        .filter-box {
            display: flex;
            gap: 10px;
        }
        
        .filter-box select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }
        
        .market-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .crop-analysis h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .placeholder-text {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px 0;
        }
        
        .crop-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .detail-item h4 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .detail-item p {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .price-change {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .price-up {
            background: #e6f7ee;
            color: #16a34a;
        }
        
        .price-down {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .market-overview .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .overview-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .overview-card h3 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .crop-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .crop-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .crop-item:last-child {
            border-bottom: none;
        }
        
        .crop-name {
            font-weight: 500;
        }
        
        .crop-price {
            font-weight: 600;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .prediction-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .prediction-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .prediction-card h4 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .prediction-card p {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .recommendation {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .recommendation-buy {
            background: #e6f7ee;
            color: #16a34a;
            border-left: 4px solid #16a34a;
        }
        
        .recommendation-sell {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #dc2626;
        }
        
        .recommendation-hold {
            background: #fffbeb;
            color: #d97706;
            border-left: 4px solid #d97706;
        }
        
        #connection-status {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            font-size: 14px;
        }
        
        #connection-status button {
            margin-left: 10px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .nav-menu {
                position: fixed;
                left: -100%;
                top: 70px;
                flex-direction: column;
                background: linear-gradient(135deg, #2c3e50, #1a2530);
                width: 100%;
                text-align: center;
                transition: 0.3s;
                box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
                padding: 20px 0;
                gap: 15px;
            }
            
            .nav-menu.active {
                left: 0;
            }
            
            .market-controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .filter-box {
                width: 100%;
            }
            
            .filter-box select {
                flex: 1;
            }
            
            .crop-details {
                grid-template-columns: 1fr;
            }
            
            .market-overview .overview-cards {
                grid-template-columns: 1fr;
            }
            
            .prediction-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <i class="fas fa-seedling"></i>
                    Krishisalah
                </a>
            </div>
            
            <ul class="nav-menu" id="nav-menu">
                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="/market" class="nav-link active">Market Analysis</a>
                </li>
                <li class="nav-item">
                    <a href="/analytics" class="nav-link">Analytics</a>
                </li>
                <li class="nav-item">
                    <a href="/reports" class="nav-link">Reports</a>
                </li>
                <li class="nav-item">
                    <a href="/resources" class="nav-link">Resources</a>
                </li>
                <li class="nav-item">
                    <a href="/status" class="nav-link">Status</a>
                </li>
            </ul>
            
            <div class="nav-auth">
                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=Farmer&background=4ecdc4&color=fff" alt="User" class="user-avatar">
                    <span id="user-name">Farmer</span>
                </div>
                <a href="#" id="logout-btn" class="nav-login">Logout</a>
            </div>
            
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <div class="market-container">
        <div class="market-header">
            <h1>Market Analysis</h1>
            <p>Get real-time market insights and price predictions for various crops</p>
        </div>

        <div class="market-controls">
            <div class="search-box">
                <input type="text" id="crop-search" placeholder="Search for a crop...">
                <button id="search-btn">Search</button>
            </div>
            <div class="filter-box">
                <select id="region-filter">
                    <option value="">All Regions</option>
                    <option value="north">North India</option>
                    <option value="south">South India</option>
                    <option value="east">East India</option>
                    <option value="west">West India</option>
                </select>
                <select id="time-filter">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                </select>
            </div>
        </div>

        <div class="market-content">
            <!-- Selected Crop Analysis -->
            <div class="crop-analysis card">
                <h2 id="selected-crop-name">Select a Crop to Analyze</h2>
                <div id="crop-analysis-content">
                    <p class="placeholder-text">Use the search box above to select a crop for detailed analysis</p>
                </div>
            </div>

            <!-- Market Overview -->
            <div class="market-overview card">
                <h2>Market Overview</h2>
                <div class="overview-cards">
                    <div class="overview-card">
                        <h3>Top Gainers</h3>
                        <div id="top-gainers" class="crop-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="overview-card">
                        <h3>Top Losers</h3>
                        <div id="top-losers" class="crop-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="overview-card">
                        <h3>Most Volatile</h3>
                        <div id="most-volatile" class="crop-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Trends Chart -->
            <div class="price-trends card">
                <h2>Price Trends</h2>
                <div class="chart-container">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <!-- Prediction Section -->
            <div class="prediction-section card">
                <h2>Price Predictions</h2>
                <div id="prediction-content">
                    <p class="placeholder-text">Select a crop to see price predictions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connection-status">
        <span id="status-text"></span>
        <button onclick="checkConnection()">Check</button>
    </div>

    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                window.location.href = '/auth';
                return;
            }
            
            // Update user name
            if (user && user.name) {
                document.getElementById('user-name').textContent = user.name;
            }
            
            // Initialize market page
            initMarketPage();
            
            // Set up event listeners
            document.getElementById('search-btn').addEventListener('click', searchCrop);
            document.getElementById('crop-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCrop();
                }
            });
            
            document.getElementById('region-filter').addEventListener('change', updateMarketData);
            document.getElementById('time-filter').addEventListener('change', updateMarketData);
            
            // Navbar functionality
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('nav-menu');
            
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                });
            }
            
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('user');
                window.location.href = '/auth';
            });
            
            // Test connection
            setTimeout(checkConnection, 2000);
        });
        
        function initMarketPage() {
            // Load market overview
            loadMarketOverview();
            
            // Load price trends chart
            initPriceChart();
        }
        
        function searchCrop() {
            const cropName = document.getElementById('crop-search').value.trim();
            
            if (!cropName) {
                alert('Please enter a crop name');
                return;
            }
            
            // Show loading state
            document.getElementById('crop-analysis-content').innerHTML = `
                <div class="loading">Loading crop data...</div>
            `;
            
            // Fetch crop analysis
            fetchCropAnalysis(cropName);
        }
        
        async function fetchCropAnalysis(cropName) {
            try {
                const response = await fetch(`http://localhost:5000/api/market?crop=${encodeURIComponent(cropName)}`);
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const analysis = await response.json();
                displayCropAnalysis(analysis);
            } catch (error) {
                console.error('Error fetching crop analysis:', error);
                // Fallback to simulated data
                simulateCropAnalysis(cropName);
            }
        }
        
        function displayCropAnalysis(analysis) {
            if (analysis.error) {
                document.getElementById('crop-analysis-content').innerHTML = `
                    <p class="error-text">${analysis.error}</p>
                `;
                return;
            }
            
            const { crop, current_price, average_price, min_price, max_price, trend, demand, supply, recommendation, predictions } = analysis;
            
            // Update crop name
            document.getElementById('selected-crop-name').textContent = `${crop.charAt(0).toUpperCase() + crop.slice(1)} Market Analysis`;
            
            // Create analysis content
            let html = `
                <div class="crop-details">
                    <div class="detail-item">
                        <h4>Current Price</h4>
                        <p>₹${current_price.toFixed(2)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Average Price</h4>
                        <p>₹${average_price.toFixed(2)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Minimum Price</h4>
                        <p>₹${min_price.toFixed(2)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Maximum Price</h4>
                        <p>₹${max_price.toFixed(2)}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Demand</h4>
                        <p>${demand}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Supply</h4>
                        <p>${supply}</p>
                    </div>
                    <div class="detail-item">
                        <h4>Trend</h4>
                        <p>${trend}</p>
                    </div>
                </div>
                
                <div class="recommendation recommendation-${recommendation.includes('buy') ? 'buy' : recommendation.includes('sell') ? 'sell' : 'hold'}">
                    <strong>Recommendation:</strong> ${recommendation}
                </div>
                
                <h3 style="margin: 20px 0 10px;">Price Predictions (Next 6 Months)</h3>
                <div class="prediction-cards">
            `;
            
            // Add prediction cards
            predictions.forEach(pred => {
                html += `
                    <div class="prediction-card">
                        <h4>Month ${pred.month}</h4>
                        <p>₹${pred.predicted_price.toFixed(2)}</p>
                        <small>Demand: ${pred.demand}, Supply: ${pred.supply}</small>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // Update DOM
            document.getElementById('crop-analysis-content').innerHTML = html;
            
            // Update price chart with this crop's data
            updatePriceChart(crop);
        }
        
        function simulateCropAnalysis(cropName) {
            // Simulated data for demonstration
            const analysis = {
                crop: cropName,
                current_price: 45.75,
                average_price: 42.30,
                min_price: 38.50,
                max_price: 52.20,
                trend: 'up',
                demand: 'high',
                supply: 'medium',
                recommendation: 'Good time to sell',
                predictions: [
                    { month: 1, predicted_price: 47.20, demand: 'high', supply: 'medium' },
                    { month: 2, predicted_price: 48.50, demand: 'high', supply: 'low' },
                    { month: 3, predicted_price: 46.80, demand: 'medium', supply: 'medium' },
                    { month: 4, predicted_price: 45.20, demand: 'medium', supply: 'high' },
                    { month: 5, predicted_price: 43.90, demand: 'medium', supply: 'high' },
                    { month: 6, predicted_price: 42.50, demand: 'low', supply: 'high' }
                ]
            };
            
            displayCropAnalysis(analysis);
        }
        
        function loadMarketOverview() {
            // Simulate API call to get market overview
            setTimeout(() => {
                const topGainers = [
                    { name: 'Tomato', price: 45.75, change: 12.5 },
                    { name: 'Onion', price: 32.20, change: 8.3 },
                    { name: 'Potato', price: 18.90, change: 5.7 }
                ];
                
                const topLosers = [
                    { name: 'Wheat', price: 22.50, change: -7.2 },
                    { name: 'Rice', price: 38.75, change: -4.8 },
                    { name: 'Corn', price: 19.30, change: -3.5 }
                ];
                
                const mostVolatile = [
                    { name: 'Garlic', price: 85.40, change: 15.2 },
                    { name: 'Ginger', price: 72.60, change: -12.8 },
                    { name: 'Turmeric', price: 120.25, change: 18.3 }
                ];
                
                displayMarketOverview('top-gainers', topGainers);
                displayMarketOverview('top-losers', topLosers);
                displayMarketOverview('most-volatile', mostVolatile);
            }, 500);
        }
        
        function displayMarketOverview(elementId, data) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            data.forEach(item => {
                const changeClass = item.change >= 0 ? 'price-up' : 'price-down';
                const changeSymbol = item.change >= 0 ? '+' : '';
                
                const itemEl = document.createElement('div');
                itemEl.className = 'crop-item';
                itemEl.innerHTML = `
                    <span class="crop-name">${item.name}</span>
                    <span>
                        <span class="crop-price">₹${item.price.toFixed(2)}</span>
                        <span class="price-change ${changeClass}">${changeSymbol}${item.change}%</span>
                    </span>
                `;
                
                container.appendChild(itemEl);
            });
        }
        
        function initPriceChart() {
            const ctx = document.getElementById('price-chart').getContext('2d');
            window.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: 'rgba(78, 205, 196, 1)',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (₹/kg)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }
        
        function updatePriceChart(crop) {
            // Simulate fetching historical price data
            setTimeout(() => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMonth = new Date().getMonth();
                
                const labels = [];
                const data = [];
                
                // Generate mock data for the past 6 months
                for (let i = 5; i >= 0; i--) {
                    const monthIndex = (currentMonth - i + 12) % 12;
                    labels.push(months[monthIndex]);
                    
                    // Base price based on crop type
                    const basePrices = {
                        'rice': 40, 'wheat': 25, 'corn': 20, 'soybean': 50, 'cotton': 65,
                        'tomato': 30, 'onion': 20, 'potato': 15, 'garlic': 70, 'ginger': 60
                    };
                    
                    const basePrice = basePrices[crop.toLowerCase()] || 30;
                    const price = basePrice * (1 + (Math.random() * 0.4 - 0.2)); // ±20% variation
                    data.push(price);
                }
                
                // Update chart
                window.priceChart.data.labels = labels;
                window.priceChart.data.datasets[0].data = data;
                window.priceChart.data.datasets[0].label = `${crop.charAt(0).toUpperCase() + crop.slice(1)} Price`;
                window.priceChart.update();
            }, 500);
        }
        
        function updateMarketData() {
            const region = document.getElementById('region-filter').value;
            const timePeriod = document.getElementById('time-filter').value;
            
            // In a real application, this would fetch new data based on filters
            alert(`Filters applied: Region - ${region || 'All'}, Period - ${timePeriod} days`);
            
            // Reload market overview
            loadMarketOverview();
        }
        
        // Connection status indicator
        async function checkConnection() {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            
            try {
                const response = await fetch('http://localhost:5000/api/health');
                if (response.ok) {
                    statusElement.style.backgroundColor = '#4ade80';
                    statusText.textContent = 'Connected to backend';
                } else {
                    statusElement.style.backgroundColor = '#f87171';
                    statusText.textContent = 'Backend error';
                }
            } catch (error) {
                statusElement.style.backgroundColor = '#f87171';
                statusText.textContent = 'Cannot connect to backend';
            }
            
            statusElement.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>